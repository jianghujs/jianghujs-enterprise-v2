{% extends 'template/jhTemplateV4.html'%}
{% block vueTemplate %}
<script type="text/html" id="app-template">
  <div>
    <v-app mobile-breakpoint="sm">
      <jh-menu />
      <v-main class="mt-15">
        <!-- 头部内容 >>>>>>>>>>>>> -->
        <div class="jh-page-second-bar px-8">
          <v-row class="align-center">
            <v-col cols="12" xs="12" sm="12" md="4" xl="3">
              <div class="py-4 text-body-1 font-weight-bold">目录管理
                <!-- 帮助页按钮 -->
                <span role="button" class="success--text font-weight-regular jh-font-size-13 ml-2" @click="isHelpPageDrawerShown = true">
                  <v-icon size="13" class="success--text">mdi-help-circle-outline</v-icon>帮助
                </span>
              </div>
            </v-col>
          </v-row>
        </div>
        <!-- <<<<<<<<<<<<< 头部内容 -->

        <!-- 页面内容 >>>>>>>>>>>>> -->
        <div class="jh-page-body-container px-8">
          <v-container class="pa-0">
            <v-card class="jh-wrapper-card">
              <v-row dense no-gutters v-if="isDirectoryLoading || (!isDirectoryLoading && directoryList)">
                <!-- 目录 -->
                <v-col cols="12" xs="12" sm="4" md="3" xl="2" class="pr-sm-2">
                  <v-card flat class="pa-6 jh-directory-card">
                    <div class="jh-card-body px-6 px-sm-0">
                      <v-skeleton-loader
                        type="list-item-three-line, list-item-three-line, list-item-three-line"
                        v-if="isDirectoryLoading"
                      ></v-skeleton-loader>
                      <template v-else>
                        <div class="d-flex align-center">
                          <span class="font-weight-medium text-subtitle-1">目录</span>
                        </div>
                        <div class="mt-4">
                          <div class="mb-2" v-for="(value, index) in directoryList" :key="index">
                            <a class="jh-font-size-14 text-decoration-none" :class="activeDirectory === value[0].appGroupName ? 'success--text' : 'text--secondary'" :href="`#${value[0].appGroupName}`" @click="activeDirectory = value[0].appGroupName">{{value[0].appGroupName}}</a>
                          </div> 
                        </div>
                      </template>
                    </div>
                  </v-card>
                </v-col>

                <!-- 应用 -->
                <v-col cols="12" xs="12" sm="8" md="9" xl="10">
                  <v-card flat class="pa-6 jh-list-card">
                    <div class="jh-card-body px-6 px-sm-0">
                      <v-skeleton-loader
                        type="list-item-three-line, list-item-three-line, list-item-three-line"
                        v-if="isDirectoryLoading"
                      ></v-skeleton-loader>
                      <template v-else>
                        <div class="mb-6" v-for="(value, index) in directoryList" :key="index">
                          <div class="font-weight-medium text-subtitle-1 mb-1" :id="`${value[0].appGroupName}`">{{value[0].appGroupName}}</div>
                          <v-row dense>
                            <v-col cols="12" xs="12" sm="12" md="4" xl="3"
                              v-for="(item, i) in value"  
                              :key="item.appId + '-' + item.loginId + '-' + item.appGroupNumber + '-' + item.appGroupItemSort + '-' + i"
                             >
                              <v-card class="rounded-lg pa-4 jh-app-card" role="button">
                                <div class="px-4 px-sm-0">
                                  <div class="d-flex align-center justify-space-between">
                                    <div class="d-flex align-center" @click="item.childPage.length === 0 && doUiAction('jump', item.url)">
                                      <!-- icon -->
                                      <div class="jh-app-icon">
                                        <div v-if="item.appIcon" v-html='item.appIcon'></div>
                                        <svg v-else t="1702548638970" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13380" width="200" height="200"><path d="M864 144.014222H559.985778a16.042667 16.042667 0 0 0-15.985778 15.985778v304.014222c0 8.789333 7.196444 15.985778 16.014222 15.985778h303.985778c8.817778 0 16.014222-7.196444 16.014222-16.014222V160.028444a16.042667 16.042667 0 0 0-16.014222-16.014222z m0 399.985778H559.985778a16.042667 16.042667 0 0 0-15.985778 16.014222v303.985778c0 8.817778 7.196444 16.014222 16.014222 16.014222h303.985778c8.817778 0 16.014222-7.224889 16.014222-16.014222V559.985778a16.042667 16.042667 0 0 0-16.014222-15.985778zM463.985778 143.985778H160.028444a16.042667 16.042667 0 0 0-16.014222 16.014222v304.014222c0 8.789333 7.224889 15.985778 16.014222 15.985778h304.014223c8.789333 0 15.985778-7.196444 15.985777-16.014222V160.028444a16.042667 16.042667 0 0 0-16.014222-16.014222z m0 400.014222H160.028444a16.042667 16.042667 0 0 0-16.014222 16.014222v303.985778c0 8.817778 7.224889 16.014222 16.014222 16.014222h304.014223c8.789333 0 15.985778-7.224889 15.985777-16.014222V559.985778a16.042667 16.042667 0 0 0-16.014222-15.985778z" fill="#333333" fill-opacity=".65" p-id="13381"></path></svg>
                                      </div>
                                      <!-- app name -->
                                      <div class="font-weight-medium text-subtitle-2 mx-3">{{item.appName}}</div>
                                    </div>
                                    <!-- 展开收起 -->
                                    <template v-if="item.childPage.length > 0">
                                      <v-icon size="16" class="success--text" v-if="!_.includes(expandApp, item.appId)" @click="doUiAction('changeExpandApp', { item, actionType: 'expand' })">mdi-plus</v-icon>
                                      <v-icon size="16" class="success--text" v-else @click="doUiAction('changeExpandApp', { item, actionType: 'collapse' })">mdi-minus</v-icon>
                                    </template>
                                  </div>
                                  <!-- 子页面 -->
                                  <div class="mt-2" v-if="_.includes(expandApp, item.appId)">
                                    <div v-for="(childPage, childIndex) in item.childPage"  key="childIndex" class="text--secondary jh-font-size-13 text-truncate mb-1"  @click="doUiAction('jump', childPage.url)"><span>{{childPage.displayName}}</span></div>
                                  </div>
                                </div>
                              </v-card>
                            </v-col>
                          </v-row> 
                        </div>
                      </template>
                    </div>
                  </v-card>
                </v-col>
              </v-row>

              <!-- 空数据 -->
              <div v-else class="text-center pt-10">暂无数据~</div>
            </v-card>
          </v-container>
        </div>
        <!-- <<<<<<<<<<<<< 页面内容 -->

        <!-- 帮助页抽屉 >>>>>>>>>>>>> -->
        <v-navigation-drawer v-model="isHelpPageDrawerShown" fixed temporary right width="80%" class="elevation-24">
          <iframe style="border: 0" :src="`/${appInfo.appId}/pageDoc#1.directory.md`" width="100%" height="100%"></iframe>
          <v-btn elevation="0" color="success" fab absolute top left small tile class="drawer-close-float-btn" @click="isHelpPageDrawerShown = false">
            <v-icon>mdi-close</v-icon>
          </v-btn>
        </v-navigation-drawer>
        <!-- <<<<<<<<<<<<< 帮助页抽屉 -->
      </v-main>
      </v-app>
    <jh-toast />
    <jhMask />
    <jhConfirmDialog />
  </div>
</script>
<div id="app">
</div>
{% endblock %}
{% block vueScript %}
<script type="module">

  new Vue({
    el: '#app',
    template: '#app-template',
    vuetify: new Vuetify(),
    data: {
      isMobile: window.innerWidth < 500,
      isHelpPageDrawerShown: false,
      
      isDirectoryLoading: true,
      directoryList: null,
      activeDirectory: null,
      expandApp: []
    },
    computed: { },
    watch: { },
    async created() { },
    mounted() {
      this.doUiAction('getTableData');
    },
    methods: {
      async doUiAction(uiActionId,uiActionData){
        switch(uiActionId){
          case 'getTableData':
            await this.getTableData();
            break;
          case 'changeExpandApp':
            await this.changeExpandApp(uiActionData);
            break;
          case 'jump':
            await this.jump(uiActionData);
            break;
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },

      /**
       * 获取表格数据
       */
      async getTableData() {
        this.isDirectoryLoading = true;
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'directory',
              actionId: 'selectItemList',
              orderBy: [{column: 'operationAt', order: 'desc'}]
            }
          }
        });

        const data = result.data.appData.resultData.rows;
        const groupData = _.chain(data).sortBy('appGroupNumber').groupBy('appGroupName').value();
        this.directoryList = _.map(groupData, value => {
          const appGroup = _.chain(value).groupBy('appId').value();
          return _.sortBy(_.map(appGroup, list => {
            return {
              ...list[0],
              childPage: list.slice(1)
            }
          }), 'appGroupItemSort')
        })
        this.expandApp = _.uniq(_.map(data, 'appId'));

        this.isDirectoryLoading = false;
      },
      changeExpandApp(funObj){
        const { item, actionType } = funObj;
        if(actionType === 'collapse'){
          this.expandApp.splice(_.indexOf(this.expandApp, item.appId), 1)
        }else if(actionType === 'expand'){
          this.expandApp.push(item.appId);
        }
      },
      jump(url) {
        window.open(url);
      }
    }
  })
</script>

<style scoped>
  .jh-wrapper-card{
    min-height: calc(100vh - 151px);
  }
  .jh-directory-card{
    height: 100%;
    min-height: calc(100vh - 151px); 
    border-right: 1px solid #F4F5F6 !important;
  }
  .jh-app-card{
    box-shadow: 0 1px 20px 0 rgb(0 0 0 / 3%) !important;
  }
  .jh-app-icon svg{
    width: 30px;
    height: 30px;
  }

  /* 移动端适配 >>>>>>>>>>>>> */
  @media (max-width: 600px){
    .jh-wrapper-card{
      min-height: auto;
    }
    .jh-card-body{
      height: auto;
    }
  }
  /* <<<<<<<<<<<<< 移动端适配 */
</style>
{% endblock %}
