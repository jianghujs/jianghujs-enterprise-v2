<template id="directory-draggable-tree-edit">
  <div>
    <!-- <v-row>
      <v-col cols="12">

      </v-col>
    </v-row> -->
    <!-- <draggable :list="appTreeObj" :animation="300" :group="{ name: 'text' }">
      <v-hover v-for="(data, index) in appTreeObj" :key="index" v-slot:default="{ hover, store }">
        {{data}}
          <b v-if="data.children && data.children.length" @click="store.toggleOpen(data)">
              {{data.open ? '-' : '+'}}&nbsp;
          </b>
          <span>{{data.text}}</span>
      </v-hover>
    </draggable> -->
    <draggable class="dragArea no-gutters" tag="v-row" :list="appTreeObj" :group="{ name: 'name' }">
      <v-col cols="12" v-for="el in appTreeObj" :key="el.name">
        <div class="text-h6 py-4">{{el.name}}
          <v-icon @click.stop="catalogAddCard(el.name)">mdi-plus</v-icon>
        </div>
        
        <draggable class="dragArea no-gutters" tag="v-row" :list="el.children" :group="{ name: 'name' }">
          <v-col cols="3" v-for="app in el.children" :key="el.name">
            <v-card class="rounded-lg pa-0" outlined role="button" style="height: 100%;">
              <div class="px-4 px-sm-0" style="height: 100%;">
                <div class="d-flex align-center justify-space-between pa-2">
                  <div class="d-flex align-center">
                    <!-- icon -->
                    <div class="jh-app-icon">
                      <svg t="1702548638970" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13380" width="200" height="200"><path d="M864 144.014222H559.985778a16.042667 16.042667 0 0 0-15.985778 15.985778v304.014222c0 8.789333 7.196444 15.985778 16.014222 15.985778h303.985778c8.817778 0 16.014222-7.196444 16.014222-16.014222V160.028444a16.042667 16.042667 0 0 0-16.014222-16.014222z m0 399.985778H559.985778a16.042667 16.042667 0 0 0-15.985778 16.014222v303.985778c0 8.817778 7.196444 16.014222 16.014222 16.014222h303.985778c8.817778 0 16.014222-7.224889 16.014222-16.014222V559.985778a16.042667 16.042667 0 0 0-16.014222-15.985778zM463.985778 143.985778H160.028444a16.042667 16.042667 0 0 0-16.014222 16.014222v304.014222c0 8.789333 7.224889 15.985778 16.014222 15.985778h304.014223c8.789333 0 15.985778-7.196444 15.985777-16.014222V160.028444a16.042667 16.042667 0 0 0-16.014222-16.014222z m0 400.014222H160.028444a16.042667 16.042667 0 0 0-16.014222 16.014222v303.985778c0 8.817778 7.224889 16.014222 16.014222 16.014222h304.014223c8.789333 0 15.985778-7.224889 15.985777-16.014222V559.985778a16.042667 16.042667 0 0 0-16.014222-15.985778z" fill="#333333" fill-opacity=".65" p-id="13381"></path></svg>
                    </div>
                    <!-- app name -->
                    <!-- <div class="font-weight-medium text-subtitle-1 grey--text text--darken-4 mx-3">{{app.name}}</div> -->
                    <v-text-field
                      class="jh-v-input font-weight-medium mt-0 pt-0 custom-text-field"
                      v-model="app.name"
                      fulled
                      single-line
                    ></v-text-field>
                  </div>
                </div>
                <!-- 子页面 -->

                <!-- <div class="draggable-placeholder" style="height: 50px;" v-if="!app.children.length"></div> -->
                <draggable class="dragArea " tag="div" :list="app.children" :group="{ name: 'name' }">
                  <div v-for="(page, childIndex) in app.children" :key="childIndex" class="jh-font-size-13 grey--text text--darken-4 text-truncate py-1 px-2">
                    <!-- <v-icon size="16" v-if="page.type == ">mdi-link-variant</v-icon> -->
                    <v-chip x-small :color="page.type == 'app' ? 'warning' : 'default'">{{page.type}}</v-chip>
                    <span class="ml-2">{{page.name}}</span>
                  </div>
                </draggable>
              </div>
            </v-card>
          </v-col>
        </draggable>
      </v-col>
    </draggable>

    <!--没有题目-->
    <!-- <v-row v-show="!formItemList.length" align="center" justify="center" class="ma-0 pa-0" style="width: 100%;">
      <v-card height="100" class="ma-12" width="100%" color="#f5f8fa" style="border: 1px dashed #333333">
        <draggable :class="keyId" :list="[]" :animation="300" group="componentGroup" style="position: relative; height: 100%;">
          <v-card-text class="text-center title draggable-placeholder">
            从左侧拖入或点选组件进行表单设计
          </v-card-text>
        </draggable>
      </v-card>
    </v-row> -->

  </div>

</template>
<script>
  var draggableElements = document.querySelectorAll('[draggable=true]');

  draggableElements.forEach(function(element) {
    element.addEventListener('dragstart', function() {
      this.classList.add('dragging');
    });

    element.addEventListener('dragend', function() {
      this.classList.remove('dragging');
    });
  });

  var dropzones = document.querySelectorAll('.dropzone');

  dropzones.forEach(function(dropzone) {
    dropzone.addEventListener('dragenter', function() {
      this.classList.add('over');
    });

    dropzone.addEventListener('dragleave', function() {
      this.classList.remove('over');
    });
  });
</script>
<script>
Vue.component("directory-draggable-tree-edit", {
  template: '#directory-draggable-tree-edit',
  vuetify: new Vuetify(),
  name: 'directory-draggable-tree-edit',
  props: {
    appList: {
      type: Array,
      default: () => []
    },
    appTreeObj: {
      type: Object,
      default: () => ([])
    },
  },
  watch: {
    appList: {
      handler: function (val, oldVal) {
        this.doUiAction('buildAppTree');
      },
      deep: true
    },
    appTreeObj: {
      handler: function (val, oldVal) {
        this.$emit('update:appTreeObj', val);
      },
      deep: true
    },
  },
  // inject: ["formItemSelect", "uuid", "optionKey"],
  mounted () {
  },
  methods: {
    async doUiAction(uiActionId,uiActionData){
      switch(uiActionId){
        case 'buildAppTree':
          await this.buildAppTree();
          break;
        case 'changeExpandApp':
          await this.changeExpandApp(uiActionData);
          break;
        case 'jump':
          await this.jump(uiActionData);
          break;
        default:
          console.error("[doUiAction] uiActionId not find", { uiActionId });
          break;
      }
    },
    buildAppTree() {
      const appList = _.cloneDeep(this.appList);
      appList.forEach((app) => {
        app.name = app.appName;
        app.type = 'app';
        app.id = app.appId;
        const appPageList = JSON.parse(app.appPageList);
        const pageList = JSON.parse(app.appPageDirectoryList);
        app.children = appPageList.filter((page) => {
          return pageList.includes(page.pageId);
        }).map((page) => {
          page.name = page.pageName;
          page.type = 'page';
          page.appId = app.appId;
          page.pageId = page.pageId;
          return page;
        })
      })
      const tree = []
      const catalogList = [];
      const groupByCatalog = _.groupBy(appList, 'appType');

      for (const appType in groupByCatalog) {
        const childList = groupByCatalog[appType];
        
        const catalog = {
          name: appType,
          type: 'catalog',
          children: childList.map((app) => {
            return {
              name: app.name,
              type: app.type,
              children: app.children,
              appId: app.appId,
              pageId: app.pageId,
            }
          })
        }
        catalogList.push(catalog);
      }
      this.appTreeObj = catalogList;
      console.log('this.appTreeObj', this.appTreeObj);
    },
    catalogAddCard(catalogName) {
      const catalog = this.appTreeObj.find((catalog) => {
        return catalog.name === catalogName;
      })
      catalog.children.unshift({
        name: '新建应用',
        type: 'app',
        children: [],
        appId: '',
        pageId: '',
      })
    },
    
  },
})
</script>

<style scoped>
.sortable-chosen {
  border: 1px dashed #0088F8;
  box-sizing: border-box;
  background: rgba(0, 136, 249, 0.09);
  color: #0088f9;
  padding: 0;
}
.sortable-ghost {
  border: 2px dashed #f00; /* red dashed border */
}
.custom-text-field input {
  font-size: 20px !important;
}
div.dragArea {
  height: calc(100% - 48px);
  min-height: 50px;
}
</style>
