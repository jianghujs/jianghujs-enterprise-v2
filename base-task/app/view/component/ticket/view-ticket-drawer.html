<template id="view-ticket-drawer">
  <v-navigation-drawer
    v-if="isUpdateDrawerShown"
    v-model="isUpdateDrawerShown"
    :permanent="isUpdateDrawerShown"
    fixed
    temporary
    right
    width="80%"
    class="elevation-24"
  >
      <!-- 抽屉标题 -->
      <v-row no-gutters>
        <span class="text-h7 font-weight-bold pa-4"
          >查看【{{updateItem.taskTitle}}】</span
        >
      </v-row>
      <v-divider class="jh-divider"></v-divider>
      <!-- 抽屉表单 -->
      <!-- <v-text-field class="jh-v-input" dense single-line filled v-model="updateItem.xxxId" :rules="validationRules.requireRules"></v-text-field> -->
        <v-row class="mt-0 px-4">
          <v-col
            cols="12"
            sm="12"
            md="12"
            v-for="(item, index) in updateItem.taskContent"
          >
            <span class="jh-input-label">
              <span v-if="item.component.required" class="red--text">*</span>
              {{item.component.label}}</span
            >
            <v-menu
              :close-on-content-click="false"
              :nudge-right="40"
              transition="scale-transition"
              offset-y
              min-width="auto"
              v-if="item.component.type === 'date'"
            >
              <template v-slot:activator="{ on, attrs }">
                <v-text-field
                  class="jh-v-input"
                  v-model="item.component.value"
                  dense
                  single-line
                  filled
                  v-bind="attrs"
                  v-on="on"
                  disabled
                  :required="item.component.required"
                ></v-text-field>
              </template>
              <v-date-picker
                v-model="item.component.value"
                no-title
                scrollable
              ></v-date-picker>
            </v-menu>

            <task-attachment-list
              :files="item.component.value"
              readonly
              v-else-if="item.component.type === 'file'"
            ></task-attachment-list>
            <component
              v-else
              class="jh-v-input"
              v-model="item.component.value"
              dense
              single-line
              filled
              disabled
              :key="index"
              :required="item.component.required"
              :is="item.component.tag"
              :placeholder="`请输入${item.component.label}`"
            ></component>
          </v-col>
          <v-col cols="12"
          sm="12"
          md="12">
            <p class="font-weight-bold text-body-1 ma-0 px-4 mt-4">审批流信息</p>
            <v-row class="ma-0 pa-0">
              <v-col cols="12" :md="isAudited ? 12 : 8">
                <span class="jh-input-label grey--text">审批列表</span>

                <v-data-table hide-default-footer :headers="auditHeaders" :items="updateItem.taskAuditConfig">
                  <template v-slot:item.status="{ item }">
                    <v-chip x-small :color="constantObj.statusColor[item.status]" v-if="item.status">{{item.status}}</v-chip>
                    <v-chip x-small color="warning" v-else>待审批</v-chip>
                  </template>
                  <template v-slot:item.remark="{ item }">
                    <div style="white-space: normal;">
                      {{ item.remark }}
                      </idv>
                  </template>
                </v-data-table>
              </v-col>

              <v-col cols="12" md="4" v-if="!isAudited && updateItem.taskStatus=='进行中'">
                <span class="jh-input-label grey--text"><span class="red--text">*</span>审批理由</span>
                <v-form ref="taskForm">
                  <v-textarea dense filled single-line placeholder="请输入审批理由" hide-details :rules="validationRules.requireRules" v-model="remark" :maxlength="250"
                    color="success" :rows="4" ></v-textarea>

                  <div class="ma-4 text-center">
                    <v-btn color="success" small class="mx-4" @click="doUiAction('handleTaskApply', '同意')">
                      同意
                    </v-btn>
                    <v-btn color="error"small  class="mx-4" @click="doUiAction('handleTaskApply', '拒绝')">
                      拒绝
                    </v-btn>
                  </div>
                </v-form>
              </v-col>
              </v-row>
        </v-col>
      </v-row>
      
    <!-- 抽屉关闭按钮 -->
    <v-btn
      elevation="0"
      color="success"
      fab
      absolute
      top
      left
      small
      tile
      class="drawer-close-float-btn"
      @click="isUpdateDrawerShown = false"
    >
      <v-icon>mdi-close</v-icon>
    </v-btn>
  </v-navigation-drawer>
</template>

<script type="module">
  Vue.component("view-ticket-drawer", {
    template: "#view-ticket-drawer",

    data: () => ({
      isUpdateDrawerShown: false,

      updateItem: {},

      isAudited: false,
      validationRules: {
        requireRules: [(v) => !!v || "必填"],
      },

      auditHeaders: [
        { text: "审批人ID", value: "userId", sortable: false, width: 90 },
        { text: "审批人", value: "username", sortable: false, width: 100 },
        { text: "审批节点", value: "position", sortable: false, width: 80 },
        { text: "状态", value: "status", sortable: false, width: 80 },
        { text: "审批理由", value: "remark", sortable: false, width: 350 },
        { text: "处理时间", value: "operationAt", sortable: false, width: 90 },
      ],
      remark: '',
    }),
    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case "open":
            await this.open(uiActionData);
            break;
          case "updateItem":
            await this.prepareUpdateValidate();
            await this.confirmUpdateItemDialog();
            await this.prepareDoUpdateItem();
            await this.doUpdateItem();
            await this.closeUpdateDrawer();
            break;
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },
      async open({ item = {} } = {}) {
        this.isUpdateDrawerShown = true;
        const newItem = {...item}

        newItem.taskAuditConfig = JSON.parse(newItem.taskAuditConfig);
        newItem.taskNoticeConfig = JSON.parse(newItem.taskNoticeConfig);
        newItem.taskContent = JSON.parse(newItem.taskContent);

        this.isAudited = (newItem.taskAuditedUserIdList || '').includes(window.userInfo.userId)

        this.updateItem = newItem;
      },
      // ---------- 修改数据 uiAction >>>>>>>>>> --------
      async prepareUpdateFormData() {
      
      },

      async openUpdateDrawer() {
        this.isUpdateDrawerShown = true;
      },

      async prepareUpdateValidate() {
        if (await this.$refs.updateForm.validate()) {
          return true;
        }
        throw new Error("请完善表单信息");
      },

      async confirmUpdateItemDialog() {
        if (
          (await window.confirmDialog({
            title: "修改",
            content: "确定修改吗？",
          })) === false
        ) {
          throw new Error("[confirmupdateFormDialog] 否");
        }
      },

      prepareDoUpdateItem() {
        const { id, ...data } = this.updateItem;

        data.taskAuditUserIdList = data.taskAuditConfig
          .map((item) => item.userId)
          .join(",");
        data.taskMemberIdList = data.taskAuditUserIdList;

        data.taskAuditConfig = JSON.stringify(data.taskAuditConfig);
        data.taskNoticeConfig = JSON.stringify(data.taskNoticeConfig);
        data.taskContent = JSON.stringify(data.taskContent);

        this.updateId = id;
        this.updateActionData = data;
      },

      async doUpdateItem() {
        await window.jhMask.show();
        await window.vtoast.loading("修改数据");
        const result = await window.jianghuAxios({
          data: {
            appData: {
              pageId: "ticketSubmitManagement",
              actionId: "updateItem",
              actionData: this.updateActionData,
              where: { id: this.updateId}
            },
          },
        });

        // await this.addNotice({
        //   ...this.updateActionData,
        //   rowId: result.data.appData.resultData.rows[0],
        // });
        this.$emit('success')
        await window.jhMask.hide();
        await window.vtoast.success("修改数据成功");
      },
      async closeUpdateDrawer() {
        this.isUpdateDrawerShown = false;
        this.updateItem = {};
        this.updateActionData = null;
      },
      // ---------- <<<<<<<<<<< 修改数据 uiAction ---------
      async addNotice(item) {
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: "noticeManagement",
              actionId: "addNotice",
              actionData: item,
            },
          },
        });
      },
    },
  });
</script>

<style scoped></style>
