<template id="view-ticket-detail-drawer">
  <v-navigation-drawer v-model="isDrawerShown" :permanent="isDrawerShown" fixed temporary right width="80%"
    class="elevation-24">

    <!-- 抽屉标题 -->
    <v-row no-gutters>
      <span class="text-h7 font-weight-bold pa-4">查看审批</span>
    </v-row>
    <v-divider class="jh-divider"></v-divider>
    <v-progress-linear v-if="isLoading" indeterminate color="primary"></v-progress-linear>

    <div v-else>
      <p class="font-weight-bold text-body-1 ma-0 px-4 mt-4">基础信息</p>
      <v-row class="ma-0 pa-0">
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label grey--text">审批名称</span>
          <div>{{detail.taskTitle}}</div>
        </v-col>
        <v-col cols="12" sm="12" md="4">
          <span class="jh-input-label grey--text">创建时间</span>
          <div>{{detail.taskCreateAt}}</div>
        </v-col>
        <v-col cols="12" sm="12" md="12">
          <span class="jh-input-label grey--text">审批状态</span>
          <div>{{detail.taskStatus}}</div>
        </v-col>
        <v-col cols="12" sm="12" md="12">
          <span class="jh-input-label grey--text">审批内容</span>
          <div>{{detail.taskContent}}</div>
        </v-col>
      </v-row>
      <p class="font-weight-bold text-body-1 ma-0 px-4 mt-4">审批流信息</p>
      <v-row class="ma-0 pa-0">
        <v-col cols="12" :md="isAudited ? 12 : 8">
          <span class="jh-input-label grey--text">审批列表</span>

          <v-data-table hide-default-footer :headers="auditHeaders" :items="detail.taskAuditConfig">
            <template v-slot:item.status="{ item }">
              <v-chip x-small :color="constantObj.statusColor[item.status]" v-if="item.status">{{item.status}}</v-chip>
              <v-chip x-small color="warning" v-else>待审批</v-chip>
            </template>
            <template v-slot:item.remark="{ item }">
              <div style="white-space: normal;">
                {{ item.remark }}
                </idv>
            </template>
          </v-data-table>
        </v-col>

        <v-col cols="12" md="4" v-if="!isAudited && detail.taskStatus=='进行中'">
          <span class="jh-input-label grey--text"><span class="red--text">*</span>审批理由</span>
          <v-form ref="taskForm">
            <v-textarea dense filled single-line placeholder="请输入审批理由" hide-details :rules="validationRules.requireRules" v-model="remark" :maxlength="250"
              color="success" :rows="4" ></v-textarea>

            <div class="ma-4 text-center">
              <v-btn color="success" small class="mx-4" @click="doUiAction('handleTaskApply', '同意')">
                同意
              </v-btn>
              <v-btn color="error"small  class="mx-4" @click="doUiAction('handleTaskApply', '拒绝')">
                拒绝
              </v-btn>
            </div>
          </v-form>
        </v-col>
      </v-row>
    </div>

    <!-- 抽屉关闭按钮 -->
    <v-btn elevation="0" color="success" fab absolute top left small tile class="drawer-close-float-btn"
      @click="isDrawerShown = false">
      <v-icon>mdi-close</v-icon>
    </v-btn>
  </v-navigation-drawer>
</template>

{% include 'component/task-child-list.html' %}
<script type="module">

  Vue.component("view-ticket-detail-drawer", {
    template: '#view-ticket-detail-drawer',
    data: () => ({
      constantObj: {
        statusColor: {
          '同意': 'success',
          '拒绝': 'error',
          '未审批': 'info',
        }
      },
      validationRules: {
        requireRules: [
          v => !!v || '必填',
        ],
      },

      isDrawerShown: false,
      detail: {
        taskAuditedUserIdList: '',
      },
      isLoading: false,
      auditHeaders: [
        { text: "审批人ID", value: "userId", sortable: false, width: 90 },
        { text: "审批人", value: "username", sortable: false, width: 100 },
        { text: "审批节点", value: "position", sortable: false, width: 80 },
        { text: "状态", value: "status", sortable: false, width: 80 },
        { text: "审批理由", value: "remark", sortable: false, width: 350 },
        { text: "处理时间", value: "operationAt", sortable: false, width: 90 },
      ],
      remark: '',
      isAudited: false,
    }),
    created() {
    },
    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case 'open':
            await this.open(uiActionData);
            await this.getTaskDetail();
            break;
          case 'handleTaskApply':
            await this.prepareCreateValidate();
            await this.confirmHandleTaskApply(uiActionData);
            await this.handleTaskApply(uiActionData);
            await this.close();
            break;
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },
      async open({ taskId }) {
        this.isDrawerShown = true;
        this.taskId = taskId;
      },
      async close() {
        this.isDrawerShown = false;
      },
      async getTaskDetail() {
        this.isLoading = true;
        const rows = (await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'noticeManagement',
              actionId: 'selectItemList',
              actionData: {},
              where: { taskId: this.taskId },
              orderBy: [{ column: 'operationAt', order: 'desc' }]
            }
          }
        })).data.appData.resultData.rows;
        this.isLoading = false;

        const row = rows[0] || {}
        row.taskAuditConfig = JSON.parse(row.taskAuditConfig || '[]')
        this.isAudited = (row.taskAuditedUserIdList || '').includes(window.userInfo.userId)
        this.detail = row
      },

      // ---------- 处理申请 >>>>>>>>>>>>> ----------
      async prepareCreateValidate() {
        if (await this.$refs.taskForm.validate()) {
          return true;
        }
        throw new Error("请完善表单信息")
      },
      async confirmHandleTaskApply(ticketAuditStatus) {
        if (await window.confirmDialog({ title: ticketAuditStatus, content: `确定${ticketAuditStatus}吗？` }) === false) {
          throw new Error("[confirmHandleTaskApply] 否");
        }
      },
      async handleTaskApply(status) {
        await window.vtoast.loading(`${status}中...`)
        await window.jianghuAxios({
          data: {
            appData: {
              pageId: 'ticketManagement',
              actionId: 'handleTicketApply',
              actionData: {
                taskId: this.taskId,
                remark: this.remark,
                status: status
              }
            }
          }
        })
        await window.vtoast.success('处理成功')
      }
      // ---------- <<<<<<<<<<<<< 处理申请 ----------

    },
  })
</script>
<style scoped>
  .text-decoration-line-through {
    text-decoration: line-through;
  }

  .todo-item {
    padding: 4px 0 4px 4px;
  }

  .todo-item input {
    padding: 0;
  }

  .todo-item-text {
    width: 100%;
  }
</style>