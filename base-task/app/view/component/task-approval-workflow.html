<template id="task-approval-workflow">
  <div>
    <v-timeline dense align-top>
      <v-timeline-item
        color="grey"
        icon="mdi-check-decagram"
        fill-dot
        small
        left
      >
        <div class="font-weight-bold">审批人</div>

        <div class="d-flex flex-wrap">
          <div cols="3" class="mr-2" v-for="item in approvalPersonList">
            <div class="small-card px-4">
              <v-avatar tile color="primary" size="25">
                <span class="white--text">{{ item.username[0] }}</span>
              </v-avatar>
              <span class="ml-1 primary--text">{{item.username}}</span>
            </div>
          </div>
          <div
            class="small-card add-block"
            v-if="!readonly"
            @click="doUiAction('startAddPerson', {key: 'approvalPersonList'})"
          >
            <v-icon color="primary" size="24">mdi-plus</v-icon>
          </div>
        </div>
      </v-timeline-item>
      <v-timeline-item color="grey" icon="mdi-send-circle" fill-dot small left>
        <div class="font-weight-bold">抄送人</div>

        <div class="d-flex flex-wrap">
          <div cols="3" class="mr-2" v-for="item in noticePersonList">
            <div class="small-card px-4">
              <v-avatar tile color="primary" size="25">
                <span class="white--text">{{ item.username[0] }}</span>
              </v-avatar>
              <span class="ml-1 primary--text">{{item.username}}</span>
            </div>
          </div>
          <div
            class="small-card add-block"
            @click="doUiAction('startAddPerson', {key: 'noticePersonList'})"
            v-if="!readonly"
          >
            <v-icon color="primary" size="24">mdi-plus</v-icon>
          </div>
        </div>

      </v-timeline-item>
    </v-timeline>

    <v-dialog v-model="isDialogShown" width="80%">
      <v-card>
        <v-row no-gutters>
          <span class="text-h7 font-weight-bold pa-4">请选择</span>
        </v-row>
        <v-divider class="jh-divider"></v-divider>
        <v-card-text>
          <v-row>
            <v-col cols="6" style="height: 400px; overflow: auto">
              <v-text-field
                v-model="search"
                label="搜索"
                class="jh-v-input mt-4"
                dense
                single-line
                filled
                clear-icon="mdi-close-circle-outline"
              ></v-text-field>

              <v-treeview
                :items="treeData"
                v-model="selectedIds"
                selectable
                :search="search"
                activatable
                open-on-click
                :filter="filter"
                :open.sync="open"
              ></v-treeview>
            </v-col>
            <v-col cols="6">
              <v-card>
                <v-card-title>已选择的人员</v-card-title>
                <v-list dense>
                  <div v-for="(item, index) in selectedItems" :key="index">
                    <v-list-item>
                      <v-list-item-avatar>
                        <v-avatar color="primary" size="30">
                          <span class="white--text"
                            >{{ item.username[0] }}</span
                          >
                        </v-avatar>
                      </v-list-item-avatar>

                      <v-list-item-title>{{ item.username }}</v-list-item-title>
                    </v-list-item>
                    <v-divider></v-divider>
                  </div>
                </v-list>
              </v-card>
            </v-col>
          </v-row>
        </v-card-text>

        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn color="primary" text @click="doUiAction('addPerson')">
            确定
          </v-btn>
          <v-btn text @click="isDialogShown=false"> 取消 </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </div>
</template>

<script type="module">
  Vue.component("task-approval-workflow", {
    template: "#task-approval-workflow",
    props: {
      approvalPersonList: {
        type: Array,
        default: () => [],
      },
      noticePersonList: {
        type: Array,
        default: () => [],
      },
      readonly: {
        type: Boolean,
        default: false,
      }
    },
    data: () => ({
      isDialogShown: false,
      userList: [],
      treeData: [],
      selectedIds: [],
      selectedItems: [],

      search: null,
      open: [],
    }),
    created() {
      this.doUiAction("getUserList");
    },
    computed: {
      filter() {
        return (item, search, textKey) => item[textKey].indexOf(search) > -1;
      },
    },
    watch: {
      selectedIds(val) {
        console.log("------------------------------------");
        console.log("selectedIds", val);
        this.setSelectedItems();
        console.log("------------------------------------");
      },
    },

    methods: {
      async doUiAction(uiActionId, uiActionData) {
        switch (uiActionId) {
          case "getUserList":
            await this.getUserList();
            await this.buildTreeData();
            break;
          case "startAddPerson":
            await this.startAddPerson(uiActionData);
            break;
          case "addPerson":
            await this.addPerson(uiActionData);
            break;
          default:
            console.error("[doUiAction] uiActionId not find", { uiActionId });
            break;
        }
      },
      async getUserList() {
        const rows = (
          await window.jianghuAxios({
            data: {
              appData: {
                pageId: "allPage",
                actionId: "getUserList",
                actionData: {},
                orderBy: [{ column: "operationAt", order: "desc" }],
              },
            },
          })
        ).data.appData.resultData.rows;
        this.userList = rows;
      },

      randomString(len) {
        const charSet =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

        return _.sample(charSet, len).toString().replace(/,/g, "");
      },
      async buildTreeData() {
        const data = this.userList;
        const treeData = [];

        data.forEach((item) => {
          const parts = item.orgFullName.split("-");
          let currentLevel = treeData;

          parts.forEach((part) => {
            let existingNode = currentLevel.find((node) => node.name === part);
            if (!existingNode) {
              const newNode = {
                id: this.randomString(6),
                name: part,
                children: [],
              };
              currentLevel.push(newNode);
              currentLevel = newNode.children;
            } else {
              currentLevel = existingNode.children;
            }
          });

          // Add the username as a leaf node
          currentLevel.push({
            id: item.userId,
            userId: item.userId,
            name: item.username,
          });
        });
        console.log("------------------------------------");
        console.log("treeData", treeData);
        console.log("------------------------------------");
        this.treeData = treeData;
      },

      async startAddPerson({ key }) {
        this.isDialogShown = true;
        this.updateKey = key;

        this.selectedItems = this[key];
        this.selectedIds = this[key].map((item) => item.userId);
      },

      async addPerson() {
        const selectedItems = this.selectedItems.map((item) => ({
          id: item.id,
          username: item.username,
          userId: item.userId,
          position: item.position,
        }));
        this.$emit(`update:${this.updateKey}`, selectedItems);
        this.isDialogShown = false;
      },

      setSelectedItems() {
        const data = [];
        this.selectedIds.map((id) => {
          const currentUser = this.userList.find((item) => item.userId === id);
          if (currentUser) {
            data.push(currentUser);
          }
        });

        this.selectedItems = data;
      },
    },
  });
</script>
<style scoped>
  .small-card {
    background: rgba(220, 235, 253, 0.5);
    border-radius: 5px;
    display: flex;
    align-items: center;
    cursor: pointer;
    height: 50px;
  }
  .add-block {
    width: 50px;
    justify-content: center;
  }
  .v-timeline {
    margin-left: -40px;
  }
</style>
