{% extends 'template/jhTemplateV4.html'%}

{% block vueTemplate %}

<!--SQL START
-- 以下为 jianghu init 工具生成的参考 SQL，使用后删除
-- 创建 page
INSERT INTO `_page` (`pageId`,`pageName`,`pageType`,`sort`,`operation`,`operationByUserId`,`operationByUser`,`operationAt`) SELECT 'groupManagement','页面','showInMenu','5','jhInsert',NULL,NULL,NULL FROM DUAL WHERE NOT EXISTS (SELECT `pageId` FROM `_page` WHERE `pageId`='groupManagement');

-- 创建 resource
INSERT INTO `_resource` (`accessControlTable`,`resourceHook`,`pageId`,`actionId`,`desc`,`resourceType`,`appDataSchema`,`resourceData`,`requestDemo`,`responseDemo`,`operation`,`operationByUserId`,`operationByUser`,`operationAt`) SELECT NULL,NULL,'groupManagement','selectItemList','✅查询-查询列表','sql','{}','{ \"table\": \"enterprise_group\", \"operation\": \"select\" }','','','insert',NULL,NULL,NULL FROM DUAL WHERE NOT EXISTS (SELECT `pageId` FROM `_resource` WHERE `pageId`='groupManagement' AND `actionId`='selectItemList');
INSERT INTO `_resource` (`accessControlTable`,`resourceHook`,`pageId`,`actionId`,`desc`,`resourceType`,`appDataSchema`,`resourceData`,`requestDemo`,`responseDemo`,`operation`,`operationByUserId`,`operationByUser`,`operationAt`) SELECT NULL,NULL,'groupManagement','insertItem','✅查询-添加成员','sql','{}','{ \"table\": \"enterprise_group\", \"operation\": \"insert\" }','','','insert',NULL,NULL,NULL FROM DUAL WHERE NOT EXISTS (SELECT `pageId` FROM `_resource` WHERE `pageId`='groupManagement' AND `actionId`='insertItem');
INSERT INTO `_resource` (`accessControlTable`,`resourceHook`,`pageId`,`actionId`,`desc`,`resourceType`,`appDataSchema`,`resourceData`,`requestDemo`,`responseDemo`,`operation`,`operationByUserId`,`operationByUser`,`operationAt`) SELECT NULL,NULL,'groupManagement','updateItem','✅查询-更新成员','sql','{}','{ \"table\": \"enterprise_group\", \"operation\": \"update\" }','','','insert',NULL,NULL,NULL FROM DUAL WHERE NOT EXISTS (SELECT `pageId` FROM `_resource` WHERE `pageId`='groupManagement' AND `actionId`='updateItem');
INSERT INTO `_resource` (`accessControlTable`,`resourceHook`,`pageId`,`actionId`,`desc`,`resourceType`,`appDataSchema`,`resourceData`,`requestDemo`,`responseDemo`,`operation`,`operationByUserId`,`operationByUser`,`operationAt`) SELECT NULL,NULL,'groupManagement','deleteItem','✅查询-删除信息','sql','{}','{ \"table\": \"enterprise_group\", \"operation\": \"delete\" }','','','insert',NULL,NULL,NULL FROM DUAL WHERE NOT EXISTS (SELECT `pageId` FROM `_resource` WHERE `pageId`='groupManagement' AND `actionId`='deleteItem');
SQL END!-->

<script type="text/html" id="app-template">
<div>
<v-app mobile-breakpoint="sm">
  <jh-menu />
  <v-main class="mt-15">
    <!-- 头部内容 >>>>>>>>>>>>> -->
    <div class="jh-page-second-bar px-8">
      <v-row class="align-center">
        <v-col cols="12" xs="12" sm="12" md="4" xl="3">
          <div class="py-4 text-body-1 font-weight-bold">组织管理
            <!-- 帮助页按钮 -->
            <span role="button" class="success--text font-weight-regular jh-font-size-13 ml-2" @click="isHelpPageDrawerShown = true">
              <v-icon size="13" class="success--text">mdi-help-circle-outline</v-icon>帮助
            </span>
          </div>
        </v-col>
        <!-- 搜索条件表单 >>>>>>>> -->
        <!-- <v-col cols="12" xs="12" sm="12" md="8" xl="9">
          <v-row class="jh-backend-form-container justify-end ma-0 py-3">
            <v-col cols="12" xs="6" sm="6" md="4" xl="3" class="pa-0 pr-0 pr-sm-2">
              <v-select v-model="serverSearchInput.gender" color="success" prefix="性别：" class="jh-v-input bg-white" :items="constantObj.gender" dense filled single-line></v-select>
            </v-col>
            <div class="jh-backend-search-btn">
              <v-btn class="elevation-0 float-right mt-2 mt-md-0" color="success" small @click="doUiAction('getTableData')">
                查询
              </v-btn>
            </div>
          </v-row>
        </v-col> -->
        <!-- <<<<<<<< 搜索条件表单 -->
      </v-row>
    </div>
    <!-- <<<<<<<<<<<<< 头部内容 -->

    <div class="jh-page-body-container px-8">
      <!-- 页面内容 >>>>>>>>>>>>> -->
      <v-card class="rounded-lg">
        <v-row class="ma-0 pa-4 pb-2">
          <v-spacer></v-spacer>
          <!-- 搜索过滤 -->
          <v-col cols="12" xs="8" sm="4" md="3" xl="2" class="pa-0">
            <v-text-field color="success" v-model="searchInput" prefix="搜索：" class="jh-v-input" dense filled single-line></v-text-field>
          </v-col>
        </v-row>

        <v-col cols="12" class="jh-fixed-table-height overflow-y-auto ">
        <!-- 树形结构 -->
          <v-treeview
            hoverable
            activatable
            :open="openIdList"
            open-all
            :items="tableDataTree"
            dense
            item-key="groupId"
            item-text="groupName"
            :filter="filter"
            :search="searchInput"
            :active="selectedItem"
          >

          <template v-slot:append="{ item, open }">
            <template v-if="constantObj.userGroupRoleList.includes('超级管理员')">
              <span>{{item.groupId ? item.groupId : item.groupPath + '-' + item.groupLastId}}</span>

              <v-icon size="20" class="ml-2" color="blue" @click.stop="doUiAction('startSetPrincipal', item)">
                mdi-account-details-outline
              </v-icon>
            </template>
            <template v-if="constantObj.userGroupRoleList.includes('超级管理员') || (item.principalId?.split(',') || []).includes(userInfo.userId)">
              <v-icon size="20" class="ml-2" color="success" @click.stop="doUiAction('startCreateItem', item)">
                mdi-plus
              </v-icon>
              <v-icon size="20" class="ml-2" color="orange" @click.stop="doUiAction('startUpdateItem', item)">
                mdi-note-edit-outline
              </v-icon>
              <v-icon size="20" class="ml-2" color="red" @click.stop="doUiAction('deleteItem', item)">
                mdi-trash-can-outline
              </v-icon>
            </template>
          </template>
        </v-treeview>
        </v-col>
      </v-card>
      <!-- 新增抽屉 -->
      <v-navigation-drawer v-if="isCreateDrawerShown" v-model="isCreateDrawerShown" :permanent="isCreateDrawerShown" fixed temporary right width="80%" class="elevation-24">
        <v-form ref="createForm" lazy-validation>
          <!-- 抽屉标题 -->
          <v-row no-gutters>
            <span class="text-h7 font-weight-bold pa-4">添加信息</span>
          </v-row>
          <v-divider class="jh-divider"></v-divider>
          <!-- 抽屉表单 -->
          <v-row class="mt-0 px-4">
            <!-- <v-text-field class="jh-v-input" dense single-line filled v-model="createItem.xxxId" :rules="validationRules.requireRules"></v-text-field> -->
             
            <v-col cols="12" sm="12" md="4">
              <span class="jh-input-label">组织Id<span class="red--text text--accent-2 ml-1">*必填</span></span>
              <v-text-field class="jh-v-input" dense single-line filled :prefix="createItem.groupPath + '-'" v-model="createItem.groupId" :rules="validationRules.requireRules"></v-text-field>
            </v-col>
             
            <v-col cols="12" sm="12" md="4">
              <span class="jh-input-label">组织名称<span class="red--text text--accent-2 ml-1">*必填</span></span>
              <v-text-field class="jh-v-input" dense single-line filled v-model="createItem.groupName" :rules="validationRules.requireRules"></v-text-field>
            </v-col>
             
            <v-col cols="12" sm="12" md="4">
              <span class="jh-input-label">组织描述</span>
              <v-text-field class="jh-v-input" dense single-line filled v-model="createItem.groupDesc"></v-text-field>
            </v-col>
             
          </v-row>

          <!-- 抽屉操作按钮 -->
          <v-row class="justify-end mx-0 mt-8 px-4">
            <v-btn color="success" @click="doUiAction('createItem')" small>保存</v-btn>
            <v-btn class="ml-2" @click="isCreateDrawerShown = false" small>取消</v-btn>
          </v-row>
        </v-form>
        <!-- 抽屉关闭按钮 -->
        <v-btn elevation="0" color="success" fab absolute top left small tile class="drawer-close-float-btn" @click="isCreateDrawerShown = false">
          <v-icon>mdi-close</v-icon>
        </v-btn>
      </v-navigation-drawer>
      <!-- 编辑抽屉 -->
      <v-navigation-drawer v-if="isUpdateDrawerShown" v-model="isUpdateDrawerShown" :permanent="isUpdateDrawerShown" fixed temporary right width="80%" class="elevation-24">
        <v-form ref="updateForm" lazy-validation>
          <!-- 抽屉标题 -->
          <v-row no-gutters>
            <span class="text-h7 font-weight-bold pa-4">修改信息</span>
          </v-row>
          <v-divider class="jh-divider"></v-divider>
          <!-- 抽屉表单 -->
          <v-row class="mt-0 px-4">
            <!-- <v-text-field class="jh-v-input" dense single-line filled v-model="updateItem.xxxId" :rules="validationRules.requireRules"></v-text-field> -->

            <v-col cols="12" sm="12" md="4">
              <span class="jh-input-label">组织Id</span>
              <v-text-field class="jh-v-input" dense single-line filled v-model="updateItem.groupId" disabled></v-text-field>
            </v-col>
             
            <v-col cols="12" sm="12" md="4">
              <span class="jh-input-label">组织名称<span class="red--text text--accent-2 ml-1">*必填</span></span>
              <v-text-field class="jh-v-input" dense single-line filled v-model="updateItem.groupName" :rules="validationRules.requireRules"></v-text-field>
            </v-col>
             
            <v-col cols="12" sm="12" md="4">
              <span class="jh-input-label">组织描述</span>
              <v-text-field class="jh-v-input" dense single-line filled v-model="updateItem.groupDesc"></v-text-field>
            </v-col>
                       
          </v-row>
          <!-- 抽屉操作按钮 -->
          <v-row class="justify-end mx-0 mt-8 px-4">
            <v-btn color="success" small @click="doUiAction('updateItem')">保存</v-btn>
            <v-btn class="ml-2" small @click="isUpdateDrawerShown = false">取消</v-btn>
          </v-row>
        </v-form>
        <!-- 抽屉关闭按钮 -->
        <v-btn elevation="0" color="success" fab absolute top left small tile class="drawer-close-float-btn" @click="isUpdateDrawerShown = false">
          <v-icon>mdi-close</v-icon>
        </v-btn>
      </v-navigation-drawer>
      <!-- 设置组织负责人 -->
      <v-dialog
        v-model="isSetPrincipalDialog"
        width="500"
        height="800"
      >
        <v-card>
          <v-card-title class="font-weight-bold" style="font-size:medium">
            请选择【{{setPrincipalItem.groupAllName}}（{{setPrincipalItem.groupId}}）】的组织负责人       
          </v-card-title>

          <div class="ma-4">
            <v-autocomplete class="jh-v-input" dense filled single-line v-model="setPrincipalItem.principalId" :items="constantObj.userList" item-text="username" item-value="userId" multiple></v-autocomplete>
          </div>
          <v-divider></v-divider>

          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn
              color="primary"
              text
              @click="doUiAction('setPrincipal')"
            >
              确定
            </v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>
      <!-- <<<<<<<<<<<<< 页面内容 -->
    </div>

    <!-- 帮助页抽屉 >>>>>>>>>>>>> -->
    <v-navigation-drawer v-if="isHelpPageDrawerLoaded" v-model="isHelpPageDrawerShown" :permanent="isHelpPageDrawerShown" fixed temporary right width="80%" class="elevation-24">
      <iframe style="border: 0" :src="`/${appInfo.appId}/pageDoc#404.md`" width="100%" height="100%"></iframe>
      <v-btn elevation="0" color="success" fab absolute top left small tile class="drawer-close-float-btn" @click="isHelpPageDrawerShown = false">
        <v-icon>mdi-close</v-icon>
      </v-btn>
    </v-navigation-drawer>
    <!-- <<<<<<<<<<<<< 帮助页抽屉 -->

  </v-main>
</v-app>

<jh-toast />
<jh-mask />
<jh-confirm-dialog />
</div>
</script>

<div id="app">
</div>

{% endblock %}

{% block vueScript %}

{% include 'common/jianghuJs/fixedTableHeightV4.html' %}
<script type="module">
new Vue({
  el: '#app',
  template: '#app-template',
  vuetify: new Vuetify(),
  data: () => ({
    isHelpPageDrawerShown: false,
    isHelpPageDrawerLoaded: false,
    isMobile: window.innerWidth < 500,
    // 表格相关数据
    isTableZebraLineShown: true,
    validationRules: {
      requireRules: [
        v => !!v || 'This is required',
      ],
    },
    // 下拉选项
    constantObj: {
      gender: [{"value": null, "text": "全部"}, {"value": "male", "text": "男"}, {"value": "female", "text": "女"}],
      userGroupRoleList: []
    },
    serverSearchInput: {
      gender: null
    },
    searchInput: null,
    isTableLoading: true,
    tableData: [],
    isCreateDrawerShown: false,
    createItem: {},
    createActionData: {},
    isUpdateDrawerShown: false,
    updateItem: {},
    updateActionData: {},
    deleteItem: {},
    setPrincipalItem:{},
    setPrincipalData:{},
    // 树形视图
    selectedItem: null,
    openIdList: [],
    tableDataTree: [],
    isSetPrincipalDialog: false,
  }),
  watch: {
    isHelpPageDrawerShown(val) {
      if (val && !this.isHelpPageDrawerLoaded) {
        this.isHelpPageDrawerLoaded = true;
      }
    },
  },
  computed: {
    
  },
  async created() {
  },
  mounted() {
    this.doUiAction('getTableData');
    this.doUiAction('getUserData');
    this.constantObj.userGroupRoleList = window.userInfo.userGroupRoleList.map(item=>item.groupId)
  },
  methods: {
    async doUiAction(uiActionId, uiActionData) {
      switch (uiActionId) {
        case 'getTableData':
          await this.getTableData();
          break;
        case 'getUserData':
          await this.getUserData();
          break;
        case 'startCreateItem':
          await this.prepareCreateFormData(uiActionData);
          await this.openCreateDrawer();
          break;
        case 'createItem':
          await this.prepareCreateValidate();
          await this.confirmCreateItemDialog();
          await this.prepareDoCreateItem();
          await this.doCreateItem();
          await this.closeCreateDrawer();
          await this.getTableData();
          break;
        case 'startUpdateItem':
          await this.prepareUpdateFormData(uiActionData);
          await this.openUpdateDrawer();
          break;
        case 'updateItem':
          await this.prepareUpdateValidate();
          await this.confirmUpdateItemDialog();
          await this.prepareDoUpdateItem();
          await this.doUpdateItem();
          await this.closeUpdateDrawer();
          await this.getTableData();
          break;
        case 'deleteItem':
          await this.prepareDeleteFormData(uiActionData);
          await this.checkAffiliatedGroup();
          await this.confirmDeleteItemDialog();
          await this.prepareDoDeleteItem();
          await this.doDeleteItem();
          await this.clearDeleteItem();
          await this.getTableData();
          break;
        case 'startSetPrincipal':
          await this.prepareSetPrincipalData(uiActionData);
          await this.openSetPrincipalDialog();
          break;
        case 'setPrincipal':
          await this.prepareSetPrincipalItem();
          await this.doSetPrincipal();
          await this.closeSetPrincipalDialog();
          await this.getTableData();
          break;
        default:
          console.error("[doUiAction] uiActionId not find", {uiActionId});
          break;
      }
    },
    /**
     * 获取表格数据
     */
    async getTableData() {
      this.isTableLoading = true;
      const rows = (await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'groupManagement',
            actionId: 'selectItemList',
            actionData: {},
            orderBy: [{column: 'groupId', order: 'asc'}]
          }
        }
      })).data.appData.resultData.rows;

      rows.forEach(row => {
        row.operationAt = dayjs(row.operationAt).format('YYYY-MM-DD HH:mm:ss');
      })
      this.tableData = rows;
      
      this.tableDataTree = this.buildTableTree(rows)
      this.isTableLoading = false;
    },
    async getUserData() {
      this.isTableLoading = true;
      const rows = (await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'groupManagement',
            actionId: 'getUserList',
            actionData: {},
            where: {
              userStatus: 'active'
            },
            orderBy: [{column: 'userId', order: 'asc'}]
          }
        }
      })).data.appData.resultData.rows;
      this.constantObj.userList = rows
    },
    buildTableTree(rows) {
      const data = rows.filter(item => !item.groupPath);
      this.selectedItem = data[0] ? [data[0]?.groupId] : [];
      // 递归  子 groupPath === 父 groupId
      const buildTree = (data) => {
        data.forEach(item => {
          item.name = item.groupName;
          const children = rows.filter(child => {
            const parentPath = item.groupId ? item.groupId : item.groupPath + '-' + item.groupLastId;
            return child.groupPath == parentPath;
          });
          if (children.length) {
            if( item.groupId == "FS" || _.countBy(item.groupId)['-'] <= 1){
                this.openIdList.push(item.groupId);
              }
            item.children = children;
            buildTree(children);
          }
        });
      };
      buildTree(data);
      return data;
    },
    // ---------- 新增数据 uiAction >>>>>>>>>> --------
    async prepareCreateFormData(item) {
      this.createItem = {};
      if (item) {
          this.createItem.groupPath = item.groupId ? item.groupId : item.groupPath + '-' + item.groupLastId;
          this.createItem.groupPathName = item.groupAllName ? item.groupAllName : "";
        }
    },

    async openCreateDrawer() {
      this.isCreateDrawerShown = true;
    },

    async prepareCreateValidate() {
      if (await this.$refs.createForm.validate()) {
        return true;
      }
      throw new Error("请完善表单信息")
    },

    async confirmCreateItemDialog() {
      if (await window.confirmDialog({title: "新增组织", content: "确定新增组织吗？"}) === false) {
        throw new Error("[confirmCreateFormDialog] 否");
      }
    },

    prepareDoCreateItem() {
      const {id, ...data} = this.createItem;
      this.createActionData = { 
        groupId: data.groupPath + '-' + data.groupId,
        groupLastId: data.groupId,
        groupPath: data.groupPath,
        groupName: data.groupName,
        groupDeptName: data.groupName,
        groupAllName: data.groupPathName == '' ? data.groupName : data.groupPathName + '-' + data.groupName 
      };
    },

    async doCreateItem() {
      await window.jhMask.show();
      await window.vtoast.loading("新增组织");
      await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'groupManagement',
            actionId: 'insertItem',
            actionData: this.createActionData
          }
        }
      })
      await window.jhMask.hide();
      await window.vtoast.success("新增组织成功");
    },
    async closeCreateDrawer() {
      this.isCreateDrawerShown = false;
      this.createItem = {};
      this.createActionData = null;
    },
    // ---------- <<<<<<<<<<< 新增数据 uiAction ---------
    // ---------- 修改数据 uiAction >>>>>>>>>>>> --------
    async prepareUpdateFormData(funObj) {
      this.updateItem = _.cloneDeep(funObj);
    },

    async openUpdateDrawer() {
      this.isUpdateDrawerShown = true;
    },

    async prepareUpdateValidate() {
      if (await this.$refs.updateForm.validate()) {
        return true;
      }
      throw new Error("请完善表单信息")
    },

    async confirmUpdateItemDialog() {
      if (await window.confirmDialog({title: "修改", content: "确定修改吗？"}) === false) {
        throw new Error("[confirmUpdateItemDialog] 否");
      }
    },

    async prepareDoUpdateItem() {
      const {id, name, ...data} = this.updateItem;
      this.updateActionData = {
        groupId: data.groupId,
        groupName: data.groupName,
        groupAllName: _.slice(data.groupAllName, 0, _.lastIndexOf(data.groupAllName,'-')).join('')+ '-' + data.groupName,
        groupDesc: data.groupDesc
      };
    },

    async doUpdateItem() {
      await window.jhMask.show();
      await window.vtoast.loading("修改数据");
      await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'groupManagement',
            actionId: 'updateItem',
            actionData: this.updateActionData,
            where: {groupId: this.updateActionData.groupId}
          }
        }
      })

      await window.jhMask.hide();
      await window.vtoast.success("修改数据成功");
    },

    async closeUpdateDrawer() {
      this.isUpdateDrawerShown = false;
      this.updateItem = {};
      this.updateActionData = null;
    },
    // ---------- <<<<<<<<<<< 修改数据 uiAction ---------
    // ---------- 删除数据 uiAction >>>>>>>>>>>> --------
    async prepareDeleteFormData(funObj) {
      this.deleteItem = _.cloneDeep(funObj);
    },
    async checkAffiliatedGroup(){
      if(this.deleteItem.children && this.deleteItem.children.length > 0){
        await window.vtoast.fail("请先删除下属组织！");
        throw new Error("[checkAffiliatedGroup] 请先删除下属组织！");
      }
    },
    async confirmDeleteItemDialog() {
      if (await window.confirmDialog({title: "删除", content: "确定删除吗？"}) === false) {
        throw new Error("[confirmDeleteItemDialog] 否");
      }
    },
    async prepareDoDeleteItem() {
      const {id} = this.deleteItem;
    },
    async doDeleteItem() {
      await window.vtoast.loading("删除数据");
      await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'groupManagement',
            actionId: 'deleteItem',
            actionData: {
              groupId: this.deleteItem.groupId
            },
            where: {}
          }
        }
      });
      await window.vtoast.success("删除数据成功");
    },
    async clearDeleteItem() {
      this.deleteItem = {};
    },
    // ---------- <<<<<<<<<<< 删除数据 uiAction ---------
    // ---------- 设置负责人 uiAction >>>>>>>>>>>> --------
    prepareSetPrincipalData(item){
      this.setPrincipalItem = {
        groupAllName: item.groupAllName,
        groupId: item.groupId,
        principalId: item.principalId?.split(',')
      }
    },
    openSetPrincipalDialog(){
      this.isSetPrincipalDialog = true
    },
    prepareSetPrincipalItem(){
      const {groupAllName, ...data} = this.setPrincipalItem;
      this.setPrincipalData = {
        groupId: data.groupId,
        principalId: data.principalId.join(',')
      }
      
    },
    async doSetPrincipal(){
      await window.jianghuAxios({
        data: {
          appData: {
            pageId: 'groupManagement',
            actionId: 'setPrincipal',
            actionData: {
              principalId: this.setPrincipalData.principalId
            },
            where: {groupId: this.setPrincipalData.groupId}
          }
        }
      })
    },
    closeSetPrincipalDialog(){
      this.isSetPrincipalDialog = false
    },
    // 重写搜索方法
    filter (value, search) {
      let newItem = _.pick(value,['groupId','groupAllName'])
      const result = _.some(newItem, itemValue =>  itemValue && itemValue.toString().includes(search));
      if(result){
        return true
      }else{
        // 特殊操作
        let {test} = value;
        return _.some(test, itemValue =>{ 
          return _.isString(itemValue.name) && itemValue['name'].includes(search)
        });
      }
    },
  }
})
</script>

<style scoped>
</style>{% endblock %}
